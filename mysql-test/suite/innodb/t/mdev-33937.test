--source include/have_innodb.inc

CREATE TABLE t1 (
    id INT UNSIGNED PRIMARY KEY,
    data VARCHAR(64)
) ENGINE = InnoDB;

INSERT INTO t1 VALUES (1, '1'), (2, '2');

--connect(con_1,localhost,root,,)
START TRANSACTION;

--connect(con_2,localhost,root,,)
START TRANSACTION;

--connection con_1
UPDATE t1 SET data = '10' where id = 1;

--connection con_2
UPDATE t1 SET data = '20' where id = 2;

--connection con_1
SET DEBUG_SYNC= 'update_sync_point SIGNAL sig';
--send UPDATE t1 SET data = '200' where id = 2

--connection con_2
SET DEBUG_SYNC= 'update_sync_point WAIT_FOR sig';
--send UPDATE t1 SET data = '100' where id = 1
--error ER_LOCK_DEADLOCK
--reap

--connection con_1
--reap
SET DEBUG_SYNC= 'RESET';
COMMIT;

--disconnect con_1
--disconnect con_2
--source include/wait_until_disconnected.inc
--connection default
SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks';
SELECT data FROM t1 ORDER BY id;
DROP TABLE t1;
--disconnect default

